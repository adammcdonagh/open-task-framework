import argparse
import logging
import os

from opentaskpy import task_run

CONFIG_PATH = f"{os.path.dirname(os.path.realpath(__file__))}/../cfg"


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("-t", "--taskId", help="Name of the JSON config to run", type=str, required=True)
    parser.add_argument("-v", "--verbosity", help="Increase verbosity", type=int)
    parser.add_argument("-c", "--configDir", help="Directory containing task configurations", type=str)

    args = parser.parse_args()

    if args.configDir:
        global CONFIG_PATH
        CONFIG_PATH = args.configDir

    logging_level = logging.INFO
    if args.verbosity == 3:
        logging_level = logging.DEBUG
    elif args.verbosity == 2:
        logging_level = 11
    elif args.verbosity == 1:
        logging_level = 12

    logging.addLevelName(11, "VERBOSE2")
    logging.addLevelName(12, "VERBOSE1")

    logging.basicConfig(
        format="%(asctime)s — %(name)s [%(threadName)s] — %(levelname)s — %(message)s",
        level=logging_level,
        handlers=[logging.StreamHandler()],
    )

    logger = logging.getLogger()
    logger.setLevel(logging_level)

    logger = logging.getLogger(__name__)
    logger.log(11, f"Log verbosity: {args.verbosity}")

    # Create the TaskRun object
    task_run_obj = task_run.TaskRun(args.taskId, CONFIG_PATH)
    try:
        task_run_obj.run()
    except Exception as e:
        logger.error(f"Error running task: {e}")
        raise e


if __name__ == "__main__":
    main()
